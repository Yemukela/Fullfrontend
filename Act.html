<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>After School Activities</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
  <script src="products.js"></script>    
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="app">
    <header>
      <h1 @click="goHome" style="cursor: pointer;" title="Go to Home">{{ sitename }}</h1>
      <input type="text" v-model="searchQuery" placeholder="Search activities..." />
      <select v-model="sortOption">
        <option value="priceAsc">Price: Low to High</option>
        <option value="priceDesc">Price: High to Low</option>
        <option value="nameAsc">Name: A-Z</option>
        <option value="nameDesc">Name: Z-A</option>
        <option value="locAsc">Location: A-Z</option>
        <option value="locDesc">Location: Z-A</option>
      </select>
      <button v-if="cartItemCount > 0" v-on:click="showCheckout">
        {{ cartItemCount }}
        <span class="fas fa-cart-plus"></span> Checkout
      </button>
    </header>

    <main>
      <!-- Product Listing -->
      <div v-if="showProduct">
        <div v-for="product in sortedProducts" :key="product.id">
          <h2>{{ product.title }}</h2>
          <figure><img :src="product.image" /></figure>
          <p v-html="product.description"></p>
          <p>Price: {{ product.price }}</p>
          <p>Available stock: {{ product.availableInventory - cartCount(product.id) }}</p>
          <button @click="addToCart(product)" :disabled="!canAddToCart(product)">
            Add to cart
          </button>
          <span v-if="product.availableInventory === cartCount(product.id)">All out!</span>
          <span v-else-if="product.availableInventory - cartCount(product.id) < 5">
            Only {{ product.availableInventory - cartCount(product.id) }} left!
          </span>
          <span v-else>Buy now!</span>
        </div>
      </div>

      <!-- Checkout -->
      <div v-else>
        <h2>Checkout</h2>
        <table class="order-summary">
          <thead>
            <tr>
              <th>Activity</th>
              <th>Qty</th>
              <th>Unit Price</th>
              <th>Subtotal</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="(product, index) in cartDetails" :key="index">
              <td><img :src="product.image" style="width: 50px;" /> {{ product.title }}</td>
              <td>
                <button @click="decreaseQuantity(product.id)" :disabled="cartCount(product.id) <= 1">âˆ’</button>
                {{ product.quantity }}
                <button @click="increaseQuantity(product.id)" :disabled="!canAddToCart(product)">+</button>
                <button class="remove-btn" @click="removeFromCart(product.id)">Remove</button>
              </td>
              <td>${{ product.price.toFixed(2) }}</td>
              <td>${{ (product.price * product.quantity).toFixed(2) }}</td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="3"><strong>Total</strong></td>
              <td><strong>${{ cartTotal }}</strong></td>
            </tr>
          </tfoot>
        </table>

        <!-- Form -->
        <p><strong>First Name:</strong> <input v-model="order.firstName" /></p>
        <p><strong>Last Name:</strong> <input v-model="order.lastName" /></p>
        <p><strong>Phone:</strong> <input v-model="order.phone" /></p>
        <p><strong>Address:</strong> <input v-model="order.address" /></p>
        <p><strong>City:</strong> <input v-model="order.city" /></p>
        <p><strong>State:</strong>
          <select v-model="order.state">
            <option disabled value="">Select State</option>
            <option v-for="(state, key) in states" :value="state">{{ key }}</option>
          </select>
        </p>
        <p><strong>Zip / Postal Code:</strong> <input v-model.number="order.zip" type="number" /></p>
        <p>
          <input type="radio" id="home" value="Home Delivery" v-model="order.method" />
          <label for="home">Home Delivery</label>
          <input type="radio" id="business" value="Business" v-model="order.method" />
          <label for="business">Business</label>
        </p>

        <button @click="submitForm">Place Order</button>
      </div>
    </main>
  </div>

  <script>
    const webstore = new Vue({
      el: '#app',
      data: {
        sitename: 'After School Activities',
        products: products,
        cart: [],
        showProduct: true,
        searchQuery: '',
        sortOption: 'priceAsc',
        order: {
          firstName: '',
          lastName: '',
          phone: '',
          address: '',
          city: '',
          state: '',
          zip: '',
          method: 'Home Delivery',
        },
        states: {
          AL: 'Alabama',
          CA: 'California',
          NV: 'Nevada',
          NY: 'New York'
        }
      },
      computed: {
        cartItemCount() {
          return this.cart.length;
        },
        cartDetails() {
          let counts = {};
          this.cart.forEach(id => counts[id] = (counts[id] || 0) + 1);
          return this.products
            .filter(p => counts[p.id])
            .map(p => ({
              ...p,
              quantity: counts[p.id]
            }));
        },
        cartTotal() {
          return this.cartDetails.reduce((total, p) => total + p.price * p.quantity, 0).toFixed(2);
        },
        sortedProducts() {
          let sorted = [...this.products].filter(p =>
            p.title.toLowerCase().includes(this.searchQuery.toLowerCase())
          );
          const compareMap = {
            priceAsc: (a, b) => a.price - b.price,
            priceDesc: (a, b) => b.price - a.price,
            nameAsc: (a, b) => a.title.localeCompare(b.title),
            nameDesc: (a, b) => b.title.localeCompare(a.title),
            locAsc: (a, b) => a.description.localeCompare(b.description),
            locDesc: (a, b) => b.description.localeCompare(a.description),
          };
          return sorted.sort(compareMap[this.sortOption]);
        }
      },
      methods: {
        addToCart(product) {
          if (this.canAddToCart(product)) this.cart.push(product.id);
        },
        removeFromCart(id) {
          this.cart = this.cart.filter(item => item !== id);
        },
        increaseQuantity(id) {
          const product = this.products.find(p => p.id === id);
          if (product && this.canAddToCart(product)) this.cart.push(id);
        },
        decreaseQuantity(id) {
          const index = this.cart.indexOf(id);
          if (index !== -1) this.cart.splice(index, 1);
        },
        cartCount(id) {
          return this.cart.filter(i => i === id).length;
        },
        canAddToCart(product) {
          return product.availableInventory > this.cartCount(product.id);
        },
        showCheckout() {
          this.showProduct = false;
        },
        goHome() {
          this.showProduct = true;
        },
        submitForm() {
          if (!this.order.firstName || !this.order.lastName || !this.order.phone || !this.order.address || !this.order.city || !this.order.state || !this.order.zip) {
            alert("Please fill in all required fields.");
            return;
          }

          const payload = {
            firstName: this.order.firstName,
            lastName: this.order.lastName,
            phone: this.order.phone,
            address: this.order.address,
            city: this.order.city,
            state: this.order.state,
            zip: this.order.zip,
            method: this.order.method,
            lessons: this.cartDetails.map(p => ({
              id: p.id,
              title: p.title,
              quantity: p.quantity,
              price: p.price
            }))
          };

          fetch("https://fullstackprojectbackend-tt3a.onrender.com/orders", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          })
          .then(res => res.json())
          .then(data => {
            alert("Order placed successfully! Order ID: " + data.orderId);
            this.cart = [];
            this.goHome();
          })
          .catch(err => {
            console.error("Error placing order:", err);
            alert("Failed to place order.");
          });
        }
      }
    });
  </script>
</body>
</html>
